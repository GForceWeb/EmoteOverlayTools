<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Overlay Config</title>

  <!-- DaisyUI + Tailwind (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    // Tailwind config (optional)
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              500: '#7c3aed',
              600: '#6d28d9',
              700: '#5b21b6',
            }
          }
        }
      },
      daisyui: {
        themes: ["dark", "light"],
      }
    }
  </script>

  <style>
    /* Ensure multi-select is comfortably tall */
    #features {
      min-height: 10rem;
    }
  </style>
</head>
<body class="min-h-screen bg-base-200">
  <!-- Top banner -->
  <div class="w-full bg-gradient-to-r from-brand-600 via-brand-500 to-brand-700 text-white">
    <div class="container mx-auto px-4 py-4">
      <div class="alert shadow-lg bg-transparent text-white border-white/20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
          <h3 class="font-bold">Want way more customization?</h3>
          <div class="text-sm opacity-90">Download the standalone app from the GitHub releases page.</div>
        </div>
        <div class="flex-none">
          <!-- TODO: Replace href with your actual releases URL -->
          <a class="btn btn-sm btn-outline btn-secondary"
             href="https://github.com/GForceWeb/EmoteOverlayTools/releases"
             target="_blank" rel="noopener noreferrer">
            Open Releases
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <main class="container mx-auto px-4 py-8">
    <div class="mb-6 flex items-center justify-between gap-4">
      <h1 class="text-3xl font-extrabold tracking-tight">Overlay Configuration</h1>
      <div class="flex items-center gap-2">
        <label class="swap swap-rotate">
          <!-- this hidden checkbox controls the state -->
          <input id="themeToggle" type="checkbox" />
          <!-- sun icon -->
          <svg class="swap-on fill-current w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M5.64 17l-1.41 1.41 1.41 1.41L7.05 18.4 5.64 17zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zM1.64 4.22l1.41-1.41L4.46 4.2 3.05 5.61 1.64 4.22zM17 5.64l1.41-1.41 1.41 1.41L18.4 7.05 17 5.64zM20 11v2h3v-2h-3zm-2.05 7.36l1.41 1.41-1.41 1.41-1.41-1.41 1.41-1.41zM12 6a6 6 0 100 12A6 6 0 0012 6z"/>
          </svg>
          <!-- moon icon -->
          <svg class="swap-off fill-current w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M21.64 13a9 9 0 11-10.73-10.64 7 7 0 0010.73 10.64z"/>
          </svg>
        </label>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Form card -->
      <section class="lg:col-span-2">
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title">Settings</h2>
            <form id="configForm" class="grid grid-cols-1 md:grid-cols-2 gap-6"></form>
            <div class="card-actions justify-end mt-4">
              <button id="resetBtn" type="button" class="btn btn-ghost">Reset</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Output card -->
      <aside class="lg:col-span-1">
        <div class="card bg-base-100 shadow-xl sticky top-6">
          <div class="card-body">
            <h3 class="card-title">Your Overlay URL</h3>
            <p class="text-sm opacity-70">Share or embed this URL in your broadcasting software/browser source.</p>
            <label class="form-control">
              <div class="label">
                <span class="label-text">Generated URL</span>
              </div>
              <div class="join w-full">
                <input id="outputURL" type="text" class="input input-bordered w-full join-item" readonly />
                <button id="copyButton" type="button" class="btn btn-primary join-item">Copy</button>
              </div>
            </label>
            <div class="mt-2 flex gap-2">
              <a id="openURL" class="btn btn-outline btn-secondary btn-sm" target="_blank" rel="noopener noreferrer">Open</a>
              <button id="refreshBtn" type="button" class="btn btn-ghost btn-sm">Refresh</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Toast container -->
  <div id="toast" class="toast toast-end z-50 hidden">
    <div class="alert alert-success">
      <span>URL copied to clipboard.</span>
    </div>
  </div>

  <script>
    // Parameters schema
    const parameters = [
      {
        name: "all",
        type: "select",
        label: "Enable All Features?",
        options: ["True", "False"],
        defaultValue: "True",
        visible: true,
      },
      {
        name: "features",
        type: "multiselect",
        label: "Specific Features to Enable",
        options: ["lurk", "welcome", "emoterain", "kappagen", "choon", "cheers", "hypetrain"],
        defaultValue: [],
        visible: false
      },
      {
        name: "maxemotes",
        type: "number",
        label: "Maximum Emotes Per Action",
        defaultValue: "200",
        visible: true
      },
      {
        name: "subonly",
        type: "select",
        label: "Restrict commands to Subscribers Only",
        options: ["True", "False"],
        defaultValue: "False",
        visible: true,
      },
      {
        name: "server",
        type: "text",
        label: "IP Address of the StreamerBot WebSocket Server",
        defaultValue: "localhost:8080",
        visible: true,
      }
    ];

    const form = document.getElementById("configForm");
    const outputURL = document.getElementById("outputURL");
    const copyButton = document.getElementById("copyButton");
    const openURL = document.getElementById("openURL");
    const resetBtn = document.getElementById("resetBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const toast = document.getElementById("toast");
    const themeToggle = document.getElementById("themeToggle");

    // Build a form control
    function createField(param) {
      const wrapper = document.createElement("label");
      wrapper.className = "form-control w-full";
      wrapper.id = param.name + "Wrapper";
      if (param.visible === false) wrapper.classList.add("hidden");

      const labelDiv = document.createElement("div");
      labelDiv.className = "label";
      const labelSpan = document.createElement("span");
      labelSpan.className = "label-text";
      labelSpan.textContent = param.label;
      labelDiv.appendChild(labelSpan);
      wrapper.appendChild(labelDiv);

      let field;
      switch (param.type) {
        case "text":
        case "number": {
          field = document.createElement("input");
          field.type = param.type;
          field.className = "input input-bordered w-full";
          field.id = param.name;
          field.name = param.name;
          field.placeholder = param.label;
          field.value = param.defaultValue ?? "";
          break;
        }
        case "select": {
          field = document.createElement("select");
          field.className = "select select-bordered w-full";
          field.id = param.name;
          field.name = param.name;
          (param.options || []).forEach((opt) => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            if (String(opt) === String(param.defaultValue)) o.selected = true;
            field.appendChild(o);
          });
          break;
        }
        case "multiselect": {
          field = document.createElement("select");
          field.className = "select select-bordered w-full";
          field.id = param.name;
          field.name = param.name;
          field.multiple = true;
          field.size = Math.min(8, (param.options || []).length || 6);
          (param.options || []).forEach((opt) => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            if ((param.defaultValue || []).includes(opt)) o.selected = true;
            field.appendChild(o);
          });
          break;
        }
        default:
          field = document.createElement("input");
          field.type = "text";
          field.className = "input input-bordered w-full";
          field.id = param.name;
          field.name = param.name;
          field.value = param.defaultValue ?? "";
      }

      wrapper.appendChild(field);
      return wrapper;
    }

    function generateForm() {
      form.innerHTML = "";
      parameters.forEach(param => {
        const control = createField(param);
        form.appendChild(control);
      });

      // Handle visibility of "features" based on "all"
      const allField = document.getElementById("all");
      const featuresWrapper = document.getElementById("featuresWrapper");

      function updateFeaturesVisibility() {
        if (allField?.value === "True") {
          featuresWrapper?.classList.add("hidden");
          const features = document.getElementById("features");
          if (features) {
            Array.from(features.options).forEach(o => (o.selected = false));
          }
        } else {
          featuresWrapper?.classList.remove("hidden");
        }
        generateURL();
      }

      allField?.addEventListener("change", updateFeaturesVisibility);
      updateFeaturesVisibility();

      // React to field changes
      form.addEventListener("input", generateURL);
      form.addEventListener("change", generateURL);
    }

    // Build URL from form state
    function generateURL() {
      const query = new URLSearchParams();

      parameters.forEach(param => {
        const field = document.getElementById(param.name);
        if (!field) return;

        if (field.tagName.toLowerCase() === "select" && field.multiple) {
          const values = Array.from(field.selectedOptions).map(o => o.value);
          // Add each selected feature as a boolean flag
          values.forEach(v => query.set(v, "true"));
          return;
        }

        const value = field.value;
        // Skip falsey booleans represented as strings
        if (value === "False" || value === "" || value == null) return;

        query.set(param.name, value);
      });

      // Target the overlay root (assume parent folder of /config/)
      const parentUrl = new URL("..", window.location.href); // one level up from /config/
      const finalUrl = parentUrl.toString().replace(/\/+$/, "/") + "?" + query.toString();

      outputURL.value = finalUrl;
      openURL.href = finalUrl;
    }

    function copyURLToClipboard() {
      const text = outputURL.value || "";
      if (!text) return;

      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text).then(showToast).catch(fallbackCopy);
      } else {
        fallbackCopy();
      }

      function fallbackCopy() {
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          showToast();
        } catch (err) {
          console.error("Could not copy URL to clipboard:", err);
        }
      }
    }

    function showToast() {
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 1600);
    }

    function resetForm() {
      parameters.forEach(param => {
        const field = document.getElementById(param.name);
        if (!field) return;

        if (field.tagName.toLowerCase() === "select" && field.multiple) {
          Array.from(field.options).forEach(o => {
            o.selected = (param.defaultValue || []).includes(o.value);
          });
        } else {
          field.value = param.defaultValue ?? "";
        }
      });
      // Ensure visibility reflects defaults
      const allField = document.getElementById("all");
      const featuresWrapper = document.getElementById("featuresWrapper");
      if (allField?.value === "True") featuresWrapper?.classList.add("hidden");
      else featuresWrapper?.classList.remove("hidden");

      generateURL();
    }

    function initThemeToggle() {
      // Keep theme preference in localStorage
      const saved = localStorage.getItem("theme") || "dark";
      document.documentElement.setAttribute("data-theme", saved);
      themeToggle.checked = saved === "light";
      themeToggle.addEventListener("change", () => {
        const next = themeToggle.checked ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
      });
    }

    // Init
    generateForm();
    generateURL();
    initThemeToggle();

    // Events
    copyButton.addEventListener("click", copyURLToClipboard);
    resetBtn.addEventListener("click", resetForm);
    refreshBtn.addEventListener("click", generateURL);
  </script>
</body>
</html>